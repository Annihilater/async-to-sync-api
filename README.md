# 异步到同步API转换

这个项目演示了如何将异步API接口封装为同步调用方式，实现了以下功能：

1. `AsyncAPI` - 模拟异步API接口，使用回调方式返回结果
2. `SPI` - 模拟回调接口，用于接收异步请求的响应
3. `SyncAPIWrapper` - 同步封装类，使用队列和事件循环将异步API转换为同步调用方式
4. `CallbackResult` - 回调结果类，用于存储和处理不同类型的回调结果
5. `format_time_utc8` - 将时间戳转换为UTC+8人类可读格式的工具函数

## 实现原理

同步封装的核心原理：

1. 在独立线程中运行事件循环
2. 使用队列存储异步回调的结果
3. 阻塞等待队列中的结果，实现同步调用
4. 超时机制确保不会无限等待
5. 支持多回调的请求处理和结果收集

## 多回调支持

该项目支持一次请求注册多个回调，并收集所有回调结果：

1. 每个回调都有唯一的回调ID
2. 支持成功、失败和超时三种结果类型
3. 在超时范围内收集尽可能多的回调结果
4. 对未返回的回调生成超时结果

更多关于模拟行为的说明，请参考 [模拟行为说明文档](docs/simulation.md)。

## 运行方式

```bash
python main.py
```

## 示例输出

```
=== 开始同步调用 (4个回调) ===
异步请求开始: req-001, 数据: {'value': '测试1'}
收到失败回调: [时间: 2023-11-15 17:38:26] 请求ID=req-001, 回调ID=req-001-cb-1, 错误=处理回调 req-001-cb-1 时发生错误
收到成功回调: [时间: 2023-11-15 17:38:27] 请求ID=req-001, 回调ID=req-001-cb-2, 结果=处理结果-测试1-req-001-cb-2
收到成功回调: [时间: 2023-11-15 17:38:28] 请求ID=req-001, 回调ID=req-001-cb-3, 结果=处理结果-测试1-req-001-cb-3
收到失败回调: [时间: 2023-11-15 17:38:29] 请求ID=req-001, 回调ID=req-001-cb-4, 错误=处理回调 req-001-cb-4 时发生错误

同步调用结果汇总: 请求ID=req-001, 共4个回调结果
成功: 2, 失败: 2, 超时: 0

=== 开始同步调用 (带超时) ===
异步请求开始: req-002, 数据: {'value': '测试2'}
收到成功回调: [时间: 2023-11-15 17:38:30] 请求ID=req-002, 回调ID=req-002-cb-1, 结果=处理结果-测试2-req-002-cb-1
回调超时: [时间: 2023-11-15 17:38:32] 回调ID=req-002-cb-2
回调超时: [时间: 2023-11-15 17:38:32] 回调ID=req-002-cb-3
回调超时: [时间: 2023-11-15 17:38:32] 回调ID=req-002-cb-4

同步调用结果汇总: 请求ID=req-002, 共4个回调结果
成功: 1, 失败: 0, 超时: 3
```

## 技术要点

- 使用`asyncio`处理异步操作
- 使用`threading`和`queue`实现线程间通信
- 使用`run_coroutine_threadsafe`在独立线程中运行协程
- 使用`datetime`模块将UTC时间戳转换为UTC+8时区的人类可读格式
- 统一回调结果模型，支持成功/失败/超时三种状态
- 资源清理和异常处理机制

## 文档

本项目提供了详细的实现文档：

- [实现细节](docs/implementation.md) - 详细的设计和实现说明
- [模拟行为说明](docs/simulation.md) - 异步回调模拟行为的解释 